{% extends 'dashboard/base/index-govbr.html' %}
{% load static %}

{% block title %}Administração de Medicação{% endblock %}
{% load widget_tweaks %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/saude/enfermagem.css' %}"/>

<style>
    .drop-container {position: relative; display: flex; gap: 10px; flex-direction: column; justify-content: center; align-items: center; height: 162px; padding: 6px; border-radius: 10px; border: 2px dashed #555; color: #444; cursor: pointer; transition: background .2s ease-in-out, border .2s ease-in-out;} 
    .drop-container:hover {background: #eee; border-color: #111;}
    .drop-container:hover .drop-title {color: #222;}
    .drop-title {color: #140101; font-size: 20px; font-weight: bold; text-align: center; transition: color .2s ease-in-out;}
    input::file-selector-button {font-weight: bold; color: dodgerblue; padding: 0.5em; border: thin solid #fff; border-radius: 3px; background-color: #fff;}
    div:where(.swal2-container) div:where(.swal2-popup) {width: 730px !important;}
    .swal2-confirm {width: 153px;}

    .badge {
        display: inline-block;
        padding: 0.35em 0.65em;
        font-size: .75em;
        font-weight: 700;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }

    /* Estilos para a tabela no mobile */

    @media (max-width: 576px) {
        .button-list-aplic {
            width: 120px !important; /* Reduz ainda mais a largura do botão */
            font-size: 10px !important; /* Reduz ainda mais o tamanho da fonte */
            padding: 0.2rem 0.4rem !important; /* Ajusta ainda mais o padding */
        }
        .badge-mobile {
            font-size: 6px !important; /* Reduz ainda mais o tamanho da fonte */
            padding: 0.1rem 0.2rem; /* Ajusta ainda mais o padding */
        }
        .badge-mobile .badge {
            margin-left: 3px; /* Ajusta ainda mais a margem interna */
            font-size: 6px !important; /* Reduz ainda mais o tamanho da fonte interna */
        }
        .overflow-xs {
        overflow-x: auto; /* Adiciona rolagem lateral */
        -webkit-overflow-scrolling: touch; /* Suaviza a rolagem no iOS */
        }
        .table-header, .table-title {
            font-size: 10px; /* Reduz o tamanho da fonte para cabeçalhos e títulos */
        }
        .br-table th, .br-table td {
            font-size: 14px; /* Reduz o tamanho da fonte para células da tabela */
            padding: 0.25rem; /* Ajusta o padding das células da tabela */
            text-align: center;
        }
        .modal-mobile {
        font-size: 8px !important; /* Reduz o tamanho da fonte */
        padding: 0.1rem 0.2rem !important; /* Ajusta o padding */
        }
        .modal-mobile .badge {
            font-size: 12px !important; /* Reduz o tamanho da fonte dos badges */
            padding: 0.1rem 0.2rem; /* Ajusta o padding dos badges */
            margin-left: 3px; /* Ajusta a margem interna dos badges */
        }
        .modal-mobile .br-button {
            width: 80px !important; /* Reduz a largura dos botões */
            font-size: 10px !important; /* Reduz o tamanho da fonte dos botões */
            padding: 0.1rem 0.2rem !important; /* Ajusta o padding dos botões */
        }
        .modal-mobile table th, .modal-mobile table td {
            font-size: 12px !important; /* Reduz o tamanho da fonte das células da tabela */
            padding: 0.1rem !important; /* Ajusta o padding das células da tabela */
        }
        .modal-mobile .br-modal-header h4 {
            font-size: 12px !important; /* Reduz o tamanho da fonte do título do modal */
        }
        .btn-mobile {
        width: 45% !important; /* Ajusta a largura dos botões para caberem lado a lado */
        font-size: 12px !important; /* Reduz o tamanho da fonte */
        padding: 0.25rem 0.5rem !important; /* Ajusta o padding */
        }
        .border-mobile {
            height: 20% !important; /* Ajusta a altura do container */
        }
    }

    @media (min-width: 768px) and (max-width: 1205px) {
        .table-tablet th, .table-tablet td {
            font-size: 12px !important; /* Ajusta o tamanho da fonte para tablets */
            padding: 0.5rem !important; /* Ajusta o padding das células da tabela */
        }
        .table-tablet .button-list-aplic {
            width: 150px !important; /* Ajusta a largura dos botões para tablets */
            font-size: 12px !important; /* Ajusta o tamanho da fonte dos botões */
            padding: 0.25rem 0.5rem !important; /* Ajusta o padding dos botões */
        }
        .table-tablet .badge-mobile {
            font-size: 10px !important; /* Ajusta o tamanho da fonte dos badges */
            padding: 0.2rem 0.4rem; /* Ajusta o padding dos badges */
        }
        .table-tablet .badge-mobile .badge {
            margin-left: 5px; /* Ajusta a margem interna dos badges */
            font-size: 10px !important; /* Ajusta o tamanho da fonte interna dos badges */
        }
    }

</style>
{% endblock %}

{% block content %}
<template>
    <div v-if="listagemReceita" class="container">
        <div class="br-card mt-1">

            <div class="card-header">
                <div class="row ml-1">
                    <div class="col-10">
                        <div class="text-weight-semi-bold text-up-02 color-title pdt-10 font-size18 fontsize15-w"><i class="fa-solid fa-stethoscope font-size20"></i> APLICAÇÃO MEDICAÇÃO/VACINA</div>
                    </div>
                </div>
            </div>
            <hr style="border-color:#f2f2f2;">

            <div class="card-content">
                <div class="container">
                    <div class="row">
                        <div class="col-7">
                            <div class="row mt-2">
                                <div class="col-6">
                                    <span style="color: #1351B4; font-size: 16px;">Nome:</span> 
                                    <span style="font-size: 16px;">${listagemReceita.paciente_nome}</span>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-6">
                                    <span style="color: #1351B4; font-size: 16px">Data Entrada:</span> 
                                    <span style="font-size: 16px;">${listagemReceita.data_entrada}</span>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-6">
                                    <span style="color: #1351B4; font-size: 16px">CNS:</span> 
                                    <span style="font-size: 16px;">${listagemReceita.paciente_cartao_sus}</span>
                                </div>
                            </div>
                            <div class="row mt-4 mb-4">
                                <div class="col-12">
                                    <span style="color: #1351B4; font-size: 16px">Tipo:</span> 
                                    <span style="font-size: 16px;">${listagemReceita.tipo}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-5 col-lg-5 col-md-5 col-sm-5 col-5 mb-3">   
                            <div class="d-flex align-items-center flex-column bd-highlight mt-2 mb-3 mt-3">
                                <div class="col-11" {% if receita_medicamento.arquivo %}onclick="window.open('{{receita_medicamento.arquivo.url}}', '_blank')"{% endif %} style="padding-left: 5px !important;padding-right: 0px !important;">
                                    <label for="fileInput" class="drop-container border-mobile" id="dropcontainer" style="border: 1px dashed #1351b4;">
                                        <i class="far fa-image text-color-blue-1gov" style="font-size: 50px; margin-right: 19px;"></i>
                                        {% if receita_medicamento.arquivo %}
                                        <span class="drop-title">Clique aqui para visualizar a foto</span>
                                    {% else %}
                                        <span class="drop-title">Atendimento sem foto anexada</span>
                                    {% endif %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-md">
                <div class="br-card hover">
                    <div class="card-content">
                        <div class="br-table overflow-xs" data-search="data-search" data-selection="data-selection" data-collapse="data-collapse" data-random="data-random">
                            <div class="table-header">
                                <div class="top-bar">
                                    <div class="table-title color-title fontsize15-w"><i class="fas fa-history"></i> LISTAGEM DE APLICAÇÕES</div><hr>
                                </div>
                            </div>

                            <table class="mt-2 table-tablet">
                                <thead>
                                    <tr>
                                        <th style="width:5%;"></th>
                                        <th class="color-title"><b>Medicação</b></th>
                                        <th class="color-title hidden-xs"><b>Dosagem</b></th>
                                        <th class="color-title hidden-xs"><b>Via</b></th>
                                        <th class="color-title hidden-xs"><b>Tipo Parental</b></th>
                                        <th class="color-title hidden-xs"><b>Posologia</b></th>
                                        <th class="color-title hidden-xs"><b>Duração</b></th>
                                        <th class="color-title visible-xs"><b></b></th>
                                        <th class="color-title"><b></b></th>
                                    </tr>
                                </thead>
                                <tbody>  
                                    <tr v-for="lista in listagemReceita.administracao_medicamento_listagem">
                                        <td style="padding: 2px;">
                                            <button class="br-button primary small ml-1 button-list-aplic" type="button" @click="getAdministracaoMedicacao(lista.id)" style="width:180px; font-size:15px; margin-top:2px;">
                                                <i class="fa-solid fa-list-check mr-1"></i> APLICAÇÕES
                                            </button>
                                            <button class="br-button primary small ml-1 visible-xs button-list-aplic" style="margin-top: 5px;" @click="modalInfoMed(lista.medicacao_nome, lista.dosagem, lista.admin_medicamentosa_nome, lista.tipo_parenteral_nome, lista.posologia, lista.observacao)"><i class="fa-solid fa-circle-plus"></i> &nbsp;</button>
                                            <button class="br-button primary small ml-1 mt-2 hidden-xs button-list-aplic" style="margin-top: 2px; width:180px;font-size:15px;" @click="abrirModalObs(lista.observacao)"><i class="fas fa-notes-medical"></i>&nbsp;OBSERVAÇÃO</button>
                                        </td>
                                        <td>${lista.medicacao_nome}</td>
                                        <td class="hidden-xs">${lista.dosagem}</td>
                                        <td class="hidden-xs">${lista.admin_medicamentosa_nome}</td>
                                        <td class="hidden-xs">${lista.tipo_parenteral_nome}</td>
                                        <td class="hidden-xs">
                                            <template v-if="lista.periodo === 0">
                                                1 dose
                                            </template>
                                            <template v-else-if="lista.periodo === 3">
                                                ${lista.posologia} horas
                                            </template>
                                            <template v-else-if="lista.periodo === 1">
                                                ${lista.quantidade} 
                                                <span v-if="lista.quantidade == 1">Semana</span><span v-else>Semanas</span>
                                            </template>
                                            <template v-else-if="lista.periodo === 2">
                                                ${lista.quantidade} 
                                                <span v-if="lista.quantidade == 1">Mês</span><span v-else>Meses</span>
                                            </template>
                                            <template v-else>
                                                ------
                                            </template>
                                        </td>
                                        <td class="hidden-xs">
                                            ${lista.periodo_nome}
                                            <p>
                                                <span v-if="lista.periodo === 0" style="color: #1250b2;">${lista.quantidade} <span v-if="lista.quantidade == 1">Dia</span></span>
                                                <span v-if="lista.periodo === 1" style="color: #1250b2;">${lista.quantidade} <span v-if="lista.quantidade == 1">Semana</span><span v-else>Semanas</span></span>
                                                <span v-if="lista.periodo === 2" style="color: #1250b2;">${lista.quantidade} <span v-if="lista.quantidade == 1">Mês</span><span v-else>Meses</span></span>
                                                <span v-if="lista.periodo === 3" style="color: var(--interactive);">${calcularMeses(lista.quantidade) ? calcularMeses(lista.quantidade) : ''}</span>
                                            </p>
                                        </td>
                                        <td>
                                            <span class="badge badge-mobile" style="font-size: 11px !important; background-color: var(--interactive-light);">
                                                SOLICITADOS <span class="badge" style="margin-left: 10px; background-color: #888;">${lista.em_aberto}</span>
                                            </span><br/>
                                            <span class="badge badge-mobile" style="font-size: 11px !important; background-color: green;">
                                                APLICADOS <span class="badge" style="margin-left: 10px; background-color: #888;">${lista.aplicados}</span>
                                            </span><br/>
                                            <span class="badge badge-mobile" style="font-size: 11px !important; background-color: red;">
                                                CANCELADOS <span class="badge" style="margin-left: 10px; background-color: #888;">${lista.cancelados}</span>
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="table-footer">
                                <div class="col-12 text-right mt-4 d-flex justify-content-between">
                                    <a href="{% url 'saude_enfermagem:administracao_medicamento_vacina_aberto_list' %}" class="br-button secondary mr-3 btn-mobile">
                                        <i class="fas fa-arrow-left"></i> VOLTAR
                                    </a>
                                    <button :disabled="!quantidadeLiberado" @click="finalizarAdministacaoMedicacaoVacina()" type="button" class="br-button primary mr-3 btn-mobile">
                                        <i class="fa-solid fa-circle-check mr-2"></i> FINALIZAR
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="br-scrim-util foco modal-mobile" id="scrimutilexamplemodal" style="z-index: 9999;" data-scrim="true">
        <div class="br-modal" aria-labelledby="titulomodalexemplo">
            <div class="br-modal-header" id="titulomodalexemplo">
                <div class="table-title color-title fontsize25-w" style="text-align: center;">
                    <h4 style="color: #1351B4 !important;">LISTAGEM DE APLICAÇÕES</h4>
                    <span class="badge" style="font-size: 11px !important; background-color: green;">
                        APLICADOS <span class="badge" style="margin-left: 10px; background-color: #888;">${quantidadeAplicada}</span>
                    </span>
                    <span class="badge" style="font-size: 11px !important; background-color: red;">
                        CANCELADOS <span class="badge" style="margin-left: 10px; background-color: #888;">${quantidadeCancelada}</span>
                    </span>
                </div>
                <hr>
            </div>
            <div class="br-modal-body">
            <p>
                <table class="mt-2">
                    <thead>
                        <tr>
                            <th style="width:5%;"></th>
                            <th style="width:5%;"></th>
                            <th class="color-title"><b>Data/Hora</b></th>
                            <th class="color-title"><b>Próxima Aplicação</b></th>
                            <th class="color-title"><b>Enfermeiro</b></th>
                            <th class="color-title"><b>Situação</b></th>
                            <th class="color-title"><b>Observação</b></th>
                        </tr>
                    </thead>
                    <tbody>  
                        <tr v-for="(lista, index) in listagemAdministracaoMedicamento">
                            <td style="padding: 5px;">
                                <button :disabled="lista.situacao !== 0 || !podeAplicar(index) || existeSolicitada(index)" class="br-button success small ml-2" type="button" @click="atualizarAdministracaoMedicacao(lista.id, 1)" style="width:130px; font-size:15px; margin-top:2px;">
                                    <i class="fa-solid fa-syringe mr-2"></i> APLICAR
                                </button>
                            </td>
                            <td style="padding: 5px;">
                                <button :disabled="lista.situacao === 2" class="br-button danger small ml-2" type="button" @click="atualizarAdministracaoMedicacao(lista.id, 2)" style="width:130px; font-size:15px; margin-top:2px; margin-right: 2px !important;">
                                    <i class="fa-solid fa-x mr-2"></i> CANCELAR
                                </button>
                            </td>
                            <td>
                                <span v-if="lista.data_hora_aplicacao">${lista.data_hora_aplicacao}</span>
                                <span v-else>----------</span>
                            </td>
                            <td>
                                <span v-if="lista.proxima_hora_aplicacao.ultimo_sequencial && lista.proxima_hora_aplicacao.ultimo_sequencial+1 === lista.sequencial">
                                    ${lista.proxima_hora_aplicacao.proximo}
                                </span>
                                <span v-else>----------</span>
                            </td>
                            <td>
                                <span v-if="lista.enfermeiro">${lista.enfermeiro_nome}</span>
                                <span v-else>----------</span>
                            </td>
                            <td>
                                <span v-if="lista.situacao === 0">Solicitado</span>
                                <span v-else-if="lista.situacao === 1">Aplicado</span>
                                <span v-else-if="lista.situacao === 2">Cancelado</span>
                                <span v-else>Cancelado</span>
                            </td>
                            <td>                       
                                <span v-if="lista.observacao">
                                    <button class="br-button primary" @click="abrirModalObs(lista.observacao)"><i class="fas fa-notes-medical mr-1"></i>Ver Observação</button>
                                </span>
                                <span v-else>----------</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </p>
            </div>
            <div class="br-modal-footer justify-content-center">
                <button class="br-button secondary" type="button" @click="abrirFecharModal()" data-dismiss="true">Fechar</button>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block script %}
<script src="{% static 'js/moment.locale.min.js' %}"></script>
<script src="{% static 'js/sweetalert2@11.min.js' %}"></script>

<script>
    moment.locale('pt-br');

    var app = new Vue({
        delimiters: ['${', '}'],
        el: '#base-vue',
        data: {
            observacao: '',
            enfermeiro: '{{enfermeiro.id}}',
            listagemReceita: null,
            administracaoMedicacaoId: '',
            listagemAdministracaoMedicamento: [],
            administracaoMedicamentoId: '{{receita_medicamento.id}}',
            ListaChamadoAdministracaoMedicamentoId: '{{object.id}}',
            textAlert: 'Deseja realmente cancelar a aplicação?',
        },
        computed: {
            quantidadeAplicada() {
                return this.listagemAdministracaoMedicamento.filter(item => item.situacao === 1 || item.situacao === '1').length;
            },
            quantidadeCancelada() {
                return this.listagemAdministracaoMedicamento.filter(item => item.situacao === 2 || item.situacao === '2').length;
            },
            quantidadeLiberado() {
                return this.listagemReceita.administracao_medicamento_listagem.every((item) => {
                    return item.em_aberto === 0;
                });
            },
            existeAplicacaoHoje() {
                self = this;

                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                
                let listagem_administracao = this.listagemAdministracaoMedicamento.some(item => {
                    if (!item.data_hora_aplicacao) return false;
                    return item.situacao === 1 && self.parseDateToMonthYear(item.data_hora_aplicacao) === `${year}-${month}-${day}`;
                });

                return listagem_administracao
            }
        },
        methods: {
            abrirModalObs(obs) {
                Swal.fire({
                    title: '<span style="margin-bottom: 20px; display: block;">Observação:</span>',
                    html: `<p style="margin-top: 10px; margin-left: 40px; margin-right: 40px;">${obs}</p>`,
                    icon: 'info',
                    confirmButtonText: 'Fechar'
                });
            },
            getReceitaMedicamento(){
                axios.get(`{% url 'saude_enfermagem:api_receita_medicamento_view' %}?receita_id=${this.administracaoMedicamentoId}`)
                .then((response)=>{  
                    this.listagemReceita =  response.data.receita
                });
            },
            getAdministracaoMedicacao(id, modal=true){
                this.administracaoMedicacaoId = id
                axios.get(`{% url 'saude_enfermagem:api_situacao_administracao_medicamento_view' %}?administracao_medicamento_id=${id}`)
                .then((response)=>{  
                    this.listagemAdministracaoMedicamento =  response.data
                    if(modal){
                        this.abrirFecharModal('abrir')
                    }
                });
            },
            atualizarAdministracaoMedicacao(id, situacao){
                self = this;
                
                if(!self.verificarAplicacao(id) && situacao === 1){
                    Swal.fire({
                        html: `<h2 class="swal2-title" id="swal2-title" style="display: block; font-size: 20px; color: var(--interactive);">Atenção!</h2>
                                <div class="swal2-html-container" id="swal2-html-container" style="display: block; font-size: 18px; color: var(--interactive); margin-top: 7px;">Tem certeza de que deseja aplicar antes do horário previsto?</div>
                                <div>
                                    <textarea id="swal2-textarea" class="swal2-textarea capslock" placeholder="Por favor, adicione a justivicativa." style="width: 80%; font-size: 16px !important;"></textarea>
                                </div>
                            `,
                        icon: "info",
                        cancelButtonText: '<i class="fa-solid fa-xmark mr-2"></i> CANCELAR',
                        confirmButtonText: '<i class="fa-solid fa-circle-check mr-2"></i> CONFIRMAR ',
                        showCancelButton: true,
                        showConfirmButton: true,
                        reverseButtons: true,
                        allowOutsideClick: false,
                        customClass: {popup: 'custom-popup-finalizar', confirmButton: 'swal2-confirm-custom', cancelButton: 'swal2-cancel-custom'},
                        preConfirm: () => {
                            const selectElement = document.getElementById('swal2-textarea');
                            const selectedValue = selectElement.value;

                            if(selectedValue === '') {
                                Swal.showValidationMessage('Adicione uma justificativa.');
                            }else{
                                const dados = {
                                    "enfermeiro": this.enfermeiro,
                                    "situacao": situacao,
                                    "observacao": selectedValue,
                                    "aplicou_antes": true,
                                }
                                axios.put("{% url 'saude_enfermagem:api_situacao_administracao_medicamento_view' %}", { id: id, ...dados })
                                .then((response)=>{  
                                    this.getAdministracaoMedicacao(this.administracaoMedicacaoId, modal=false)
                                    this.getReceitaMedicamento();
                                    this.SweetAlert("APLICAÇÃO SALVA COM SUCESSO!", "success")
                                });
                            }
                        },
                    });
                }else{
                    if(situacao === 2){
                        Swal.fire({
                            html: `<h2 class="swal2-title" id="swal2-title" style="display: block; font-size: 20px; color: var(--interactive);">Atenção!</h2>
                                    <div class="swal2-html-container" id="swal2-html-container" style="display: block; font-size: 18px; color: var(--interactive); margin-top: 7px;">${self.textAlert}</div>
                                    <div>
                                        <textarea id="swal2-textarea" class="swal2-textarea capslock" placeholder="Por favor, adicione a justivicativa." style="width: 80%; font-size: 16px !important;"></textarea>
                                    </div>
                                `,
                            icon: "warning",
                            cancelButtonText: '<i class="fa-solid fa-xmark mr-2"></i> CANCELAR',
                            confirmButtonText: '<i class="fa-solid fa-circle-check mr-2"></i> CONFIRMAR ',
                            showCancelButton: true,
                            showConfirmButton: true,
                            reverseButtons: true,
                            allowOutsideClick: false,
                            customClass: {popup: 'custom-popup-finalizar', confirmButton: 'swal2-confirm-custom', cancelButton: 'swal2-cancel-custom'},
                            preConfirm: () => {
                                const selectElement = document.getElementById('swal2-textarea');
                                const selectedValue = selectElement.value;

                                if(selectedValue === '') {
                                    Swal.showValidationMessage('Adicione uma justificativa.');
                                }else{
                                    const dados = {
                                        "enfermeiro": this.enfermeiro,
                                        "situacao": situacao,
                                        "observacao": selectedValue,
                                        "cancelou": true,
                                    }
                                    axios.put("{% url 'saude_enfermagem:api_situacao_administracao_medicamento_view' %}", { id: id, ...dados })
                                    .then((response)=>{  
                                        this.getAdministracaoMedicacao(this.administracaoMedicacaoId, modal=false)
                                        this.getReceitaMedicamento()
                                        this.SweetAlert("APLICAÇÃO CANCELADA COM SUCESSO!", "warning")
                                    });
                                }
                            },
                        });
                    }else{
                        const dados = {
                            "enfermeiro": this.enfermeiro,
                            "situacao": situacao,
                            "observacao": this.observacao,
                        }
                        axios.put("{% url 'saude_enfermagem:api_situacao_administracao_medicamento_view' %}", { id: id, ...dados })
                        .then((response)=>{  
                            this.getAdministracaoMedicacao(this.administracaoMedicacaoId, modal=false)
                            this.getReceitaMedicamento();
                            this.SweetAlert("APLICAÇÃO SALVA COM SUCESSO!", "success")
                        });
                    } 
                }
            },
            finalizarAdministacaoMedicacaoVacina(){

                Swal.fire({
                    title: "Finalizar aplicações",
                    text: "Deseja realmente finalizar todas as aplicações?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Sim, Salvar!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Aguarde...',
                            html: 'Aguarde enquanto estamos salvando as informações.',
                            showConfirmButton: false,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            didOpen: () => {
                                Swal.showLoading()
                            }
                        });
                        url = "{% url 'saude_enfermagem:api_finalizar_situacao_administracao_medicamento_vacina_view' pk='00000000-0000-0000-0000-000000000000' %}"
                        axios.put(url.replace("00000000-0000-0000-0000-000000000000", this.ListaChamadoAdministracaoMedicamentoId), {situacao: 4})
                        .then((response)=>{  
                            Swal.fire({
                                icon: "success",
                                imageWidth: 125,
                                imageHeight: 125,
                                title: 'Atenção!',
                                text: "A administração das medicações foi concluída com sucesso!",
                                showCancelButton: false,
                                confirmButtonColor: "#3085d6",
                                cancelButtonColor: "#fff",
                                confirmButtonText: "OK",
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = '{% url "saude_enfermagem:administracao_medicamento_vacina_aberto_list" %}';
                                }
                            });
                        });
                    }
                });
            },
            parseDateToMonthYear(dateString) {
                const [day, month, yearAndTime] = dateString.split('/');
                const [year] = yearAndTime.split(' ');
                return `${year}-${month}-${day}`;
            },
            existeSolicitada(index) {
                for (let i = 0; i < index; i++) {
                    if (this.listagemAdministracaoMedicamento[i].situacao === 0) {
                        return true;
                    }
                }
                return false;
            },
            podeAplicar(index) {
                if (index === 0) {
                    return this.listagemAdministracaoMedicamento[index].situacao === 0;
                }
                const itemAnterior = this.listagemAdministracaoMedicamento[index - 1];
                
                return itemAnterior.situacao === 1 || itemAnterior.situacao === 2 && this.listagemAdministracaoMedicamento[index].situacao === 0;
            },
            abrirFecharModal(tipo=null){
                if(tipo == 'abrir'){
                    $('#scrimutilexamplemodal').show()
                }else{
                    $('#scrimutilexamplemodal').hide()
                }
            },
            modalInfoMed(nome, dosagem, medicamentosa, parental, posologia, observacao){
                if (observacao === ''){
                    observacao = 'Sem observação'
                }
                Swal.fire({
                    html: `
                    <div class="swal2-title swal2-title-custom text-left" id="swal2-title">
                        <div class="row">
                            <div class="col-9">
                                <h2 class="ml-3 mt-n1"><label class="text-color-blue-1gov custom-text font-size20">Detalhes do Medicamento</label></h2>
                            </div>
                            <div class="col-3">
                                <button type="button" class="close" style="background-color:#0459A1; border:none; color:white; font-size:15px; width:30px; height:30px;" aria-label="Close" onclick="Swal.close()">X</button>
                            </div>
                        </div>
                    </div>

                    <div class="container">

                        <div class="row font-size16">
                            <div class="col-3 color-title">
                                <span class="">Medicamento:</span>
                            </div>
                            <div class="col-9">
                                <span>${nome}<span/>
                            </div>
                        </div><hr/>

                        <div class="row font-size16 mt-2">
                            <div class="col-3 color-title">
                                <span>Dosagem:</span>
                            </div>
                            <div class="col-9">
                                <span>${dosagem}</span>
                            </div>
                        </div><hr/>

                        <div class="row font-size16 mt-2">
                            <div class="col-3 color-title">
                                <span>Via de Administração Medicamentosa:</span>
                            </div>
                            <div class="col-9">
                                <span>${medicamentosa}</span>
                            </div>
                        </div><hr/>

                        <div class="row font-size16 mt-2">
                            <div class="col-3 color-title">
                                <span>Tipo Parental:</span>
                            </div>
                            <div class="col-9">
                                <span>${parental}</span>
                            </div>
                        </div><hr/>

                        <div class="row font-size16 mt-2">
                            <div class="col-3 color-title">
                                <span>Posologia:</span>
                            </div>
                            <div class="col-9">
                                <span>${posologia}</span>
                            </div>
                        </div><hr/>                      

                        <div class="row font-size16 mt-2">
                            <div class="col-3 color-title">
                                <span>Observação:</span>
                            </div>
                            <div class="col-9">
                                <span>${observacao}</span>
                            </div>
                        </div><hr/>                        

                    </div>
                    `,
                    confirmButtonColor: "#1250b4",
                    confirmButtonText: '<i class="fa-regular fa-floppy-disk mr-2"></i>Salvar',
                    cancelButtonText: '<i class="fa-solid fa-xmark mr-2"></i> Fechar',
                    showCancelButton: false,
                    showConfirmButton: false,
                    //reverseButtons: true,
                    allowOutsideClick: true,
                });
            },
            SweetAlert(titulo, icon){
                Swal.fire({
                    toast: true,
                    position: "top-end",
                    title: titulo,
                    icon: icon,
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: (toast) => {toast.onmouseenter = Swal.stopTimer; toast.onmouseleave = Swal.resumeTimer;
                    },
                    customClass: {container: 'custom-swal-container', title: 'custom-swal-title'},
                });
            },
            calcularMeses(duracaoTratamento) {
                const meses = Math.floor(duracaoTratamento / 30);
                const diasRestantes = duracaoTratamento % 30;
                
                if (meses > 0 && diasRestantes > 0) {
                    return `${meses} mês${meses > 1 ? 'es' : ''} e ${diasRestantes} dia${diasRestantes > 1 ? 's' : ''}`;
                } else if (meses > 0) {
                    return `${meses} mês${meses > 1 ? 'es' : ''}`;
                } else if(duracaoTratamento){
                    return `${duracaoTratamento} dia${duracaoTratamento > 1 ? 's' : ''}`;
                }
            },
            verificarAplicacao(id) {
                let administracaoMedicamento = this.listagemAdministracaoMedicamento.find((item) => item.id === id);

                if (administracaoMedicamento && administracaoMedicamento.proxima_hora_aplicacao && administracaoMedicamento.proxima_hora_aplicacao.proximo) {
                    let proximaDataHora = moment(administracaoMedicamento.proxima_hora_aplicacao.proximo, 'DD/MM/YYYY HH:mm');

                    let dataAtual = moment();

                    return !proximaDataHora.isAfter(dataAtual);
                } else {
                    return true;
                }
            },
            convertDate(originalDate, format) {
                const convertedDate = moment(originalDate).format(format);
            
                return convertedDate;
            },
        },
        mounted(){
            this.getReceitaMedicamento()
        }
    });
</script>
{% endblock %}